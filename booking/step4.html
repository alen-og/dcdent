<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ - –î–æ–∫—Ç–æ—Ä –î–µ–Ω—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <header class="header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <button onclick="history.back()" style="background: none; border: none; font-size: 24px; cursor: pointer;">‚Üê</button>
            <span class="header-title">–ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏—ë–º</span>
        </div>
    </header>

    <main>
        <div class="booking-steps">
            <div class="step completed"></div>
            <div class="step completed"></div>
            <div class="step completed"></div>
            <div class="step active"></div>
        </div>

        <div class="section">
            <div class="section-title">–®–∞–≥ 4: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
        </div>

        <div class="summary" id="booking-summary">
            <div class="loader"><div class="spinner"></div></div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 12px;">üìù –ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π</h3>
            <ul style="margin: 0; padding-left: 20px; color: var(--text-secondary);">
                <li>–ü–∞—Å–ø–æ—Ä—Ç (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∏–∑–∏—Ç–µ)</li>
                <li>–ü–æ–ª–∏—Å –û–ú–° (–µ—Å–ª–∏ –µ—Å—Ç—å)</li>
                <li>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–Ω–∏–º–∫–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)</li>
            </ul>
            <p style="margin-top: 12px; font-size: 14px; color: var(--text-muted);">
                ‚è∞ –ü—Ä–æ—Å–∏–º –ø—Ä–∏–π—Ç–∏ –∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            </p>
        </div>
    </main>

    <div class="bottom-bar">
        <button class="btn btn-success btn-block btn-lg" onclick="confirmBookingStep()">
            ‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å
        </button>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/telegram.js"></script>
    <script src="../js/app.js"></script>
    <script>
        let bookingData = {};

        async function confirmBookingStep() {
            const user = getTelegramUser();

            if (!bookingData.service?.id || !bookingData.doctor?.id || !bookingData.date || !bookingData.time) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            const result = await apiPost('/appointments', {
                telegram_id: user.id,
                service_id: bookingData.service.id,
                doctor_id: bookingData.doctor.id,
                branch_id: bookingData.branch?.id || 1,
                date: bookingData.date,
                time: bookingData.time
            });

            if (result && result.id) {
                hapticFeedback('success');
                localStorage.removeItem('booking');
                window.location.href = 'success.html';
            } else {
                hapticFeedback('error');
                showAlert(result?.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            bookingData = JSON.parse(localStorage.getItem('booking') || '{}');
            const summaryContainer = document.getElementById('booking-summary');

            if (!bookingData.service || !bookingData.doctor || !bookingData.date || !bookingData.time) {
                window.location.href = 'step1.html';
                return;
            }

            let branchInfo = '–£—Ç–æ—á–Ω—è–µ—Ç—Å—è';
            if (bookingData.branch?.id) {
                const branch = await apiGet(`/branches/${bookingData.branch.id}`);
                if (branch) {
                    branchInfo = `${branch.short_name}<br><small style="color: var(--text-muted)">${branch.address}</small>`;
                }
            }

            const dateObj = new Date(bookingData.date);
            const formattedDate = dateObj.toLocaleDateString('ru-RU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            summaryContainer.innerHTML = `
                <div class="summary-item">
                    <span class="summary-label">ü¶∑ –£—Å–ª—É–≥–∞</span>
                    <span class="summary-value">${bookingData.service.name}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">üë®‚Äç‚öïÔ∏è –í—Ä–∞—á</span>
                    <span class="summary-value">${bookingData.doctor.name}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">üìÖ –î–∞—Ç–∞</span>
                    <span class="summary-value">${formattedDate}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">üïê –í—Ä–µ–º—è</span>
                    <span class="summary-value">${bookingData.time}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">üìç –§–∏–ª–∏–∞–ª</span>
                    <span class="summary-value">${branchInfo}</span>
                </div>
                <div class="summary-item summary-total">
                    <span class="summary-label">üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å</span>
                    <span class="summary-value">${bookingData.service.price ? bookingData.service.price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '–£—Ç–æ—á–Ω—è–µ—Ç—Å—è'}</span>
                </div>
            `;

            showBackButton(() => history.back());
        });
    </script>
</body>
</html>

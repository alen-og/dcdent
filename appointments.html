<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ–∏ –∑–∞–ø–∏—Å–∏ - –î–æ–∫—Ç–æ—Ä –î–µ–Ω—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header class="header">
        <div class="header-logo">
            <img src="https://static.tildacdn.com/tild3363-3137-4861-b163-386131626365/DrDent_1.png" alt="–î–æ–∫—Ç–æ—Ä –î–µ–Ω—Ç">
            <span class="header-title">–î–æ–∫—Ç–æ—Ä –î–µ–Ω—Ç</span>
        </div>
    </header>

    <main>
        <nav class="nav-tabs">
            <button class="nav-tab" onclick="location.href='index.html'">–ì–ª–∞–≤–Ω–∞—è</button>
            <button class="nav-tab" onclick="location.href='services.html'">–£—Å–ª—É–≥–∏</button>
            <button class="nav-tab" onclick="location.href='doctors.html'">–í—Ä–∞—á–∏</button>
            <button class="nav-tab active" onclick="location.href='appointments.html'">–ó–∞–ø–∏—Å–∏</button>
        </nav>

        <div id="appointments-list" style="padding-bottom: 80px;">
            <div class="loader"><div class="spinner"></div></div>
        </div>
    </main>

    <div class="fab-container">
        <button class="fab" onclick="toggleContactMenu()">üìû</button>
        <div class="fab-menu" id="contactMenu">
            <a href="tel:+78312660003" class="fab-item">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å<small>+7 (831) 266-00-03</small></a>
            <a href="https://wa.me/78312660003" class="fab-item" target="_blank">üí¨ WhatsApp</a>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/telegram.js"></script>
    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('appointments-list');
            const user = getTelegramUser();
            const appointments = await apiGet(`/appointments?telegram_id=${user.id}`);

            if (!appointments || appointments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                        <a href="booking/step1.html" class="btn btn-primary" style="margin-top: 16px">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = appointments.map(a => `
                <div class="appointment-card">
                    <div class="appointment-header">
                        <div class="appointment-date">${formatDate(a.appointment_date)}</div>
                        <div class="appointment-time">${a.appointment_time}</div>
                    </div>
                    <div class="appointment-body">
                        <div class="appointment-service">${a.service?.name || '–£—Å–ª—É–≥–∞'}</div>
                        <div class="appointment-doctor">üë®‚Äç‚öïÔ∏è ${a.doctor?.name || '–í—Ä–∞—á'}</div>
                        <div class="appointment-branch">üìç ${a.branch?.address || '–ê–¥—Ä–µ—Å'}</div>
                    </div>
                    <div class="appointment-actions">
                        <button class="btn btn-secondary" onclick="cancelAppointmentPage(${a.id})">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                        <a href="booking/step3.html?reschedule=${a.id}" class="btn btn-primary">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</a>
                    </div>
                </div>
            `).join('');
        });

        async function cancelAppointmentPage(id) {
            showConfirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?', async (confirmed) => {
                if (confirmed) {
                    const result = await apiDelete(`/appointments/${id}`);
                    if (result?.success) {
                        hapticFeedback('success');
                        location.reload();
                    } else {
                        hapticFeedback('error');
                        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–ø–∏—Å–∏');
                    }
                }
            });
        }
    </script>
</body>
</html>
